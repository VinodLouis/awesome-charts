<link rel="import" href="../polymer/polymer-element.html">
<script src="../d3/d3.js"></script>
<dom-module id="awesome-stacked-bar-chart">
    <template>
        <style>
            :host {
            display: block;
            }
            .axis .domain {
              display: none;
            }



        </style>
        <h2>Hello [[prop1]]!</h2>

        <div id="groundStackedBarChart"></div>
    </template>

    <script>
    /**
     * `awesome-charts`
     *
     *
     * @customElement
     * @polymer
     * @demo demo/index.html
     */
    class AwesomeStackedBarChart extends Polymer.Element {
      static get is() { return 'awesome-stacked-bar-chart'; }
      static get properties() {
        return {
          chartConfig:{
            type: Object
          },
          defaultConfig:{
            type: Object,
            value:{
                chartSize:300,
                label:"State",
                values:["Under 5 Years","5 to 13 Years"],
                color:[],
                valueFormat:".2s",
            }
          },
           prop1: {
            type: String,
            value: 'awesome-charts'
          },
          data:{
            type: Array,
            observer:'_dataChanged'
          }
        };
      }
      ready(){
        super.ready();
        this.paintDelayedChart();
      }
      _dataChanged(val){
        if(val){
            this.paintDelayedChart();
        }
      }
      paintDelayedChart(){
        var self = this;
        setTimeout(()=>self.drawPieChartViz(),0)
      }
      drawPieChartViz(){
        this.chartConfig = Object.assign(JSON.parse(JSON.stringify(this.defaultConfig)),this.chartConfig);

        //Set Dimensions
        var self = this;
        var currHover = null;
        var ow = (this.offsetWidth == 0) ? this.chartConfig.chartSize : this.offsetWidth;
        var width = Math.floor(ow);
        var height = Math.floor(ow*0.70);
        var maxValue = 0;

        //Remove the old scraps
        d3.select(this.$.groundStackedBarChart).html("");

        //Prepare playground
        var svg = d3.select(this.$.groundStackedBarChart).append("svg")
        .attr("width", width)
        .attr("height", height)
        .attr("id","ground")

        //Set Margins
        var margin = {top: 20, right: 80, bottom: 30, left: 40},
        width = width - margin.left - margin.right,
        height = height - margin.top - margin.bottom,
        g = svg.append("g").attr("transform", "translate(" + margin.left + "," + margin.top + ")");

        var x = d3.scaleBand()
        .rangeRound([0, width])
        .paddingInner(0.05)
        .align(0.1);

        var y = d3.scaleLinear()
        .rangeRound([height, 0]);

        var color = (this.chartConfig.color.length > 0) ? this.chartConfig.color : d3.schemeCategory20;

        var keys = this.chartConfig.values;

        this.data.forEach((d)=>{
            d.total = 0;
            keys.forEach((el)=>{
                d.total += d[el];
            });
        });
        
        //data.sort(function(a, b) { return b.total - a.total; });
        
        x.domain(this.data.map((d) => d[this.chartConfig.label]));
        y.domain([0, d3.max(this.data, (d) => d.total)]).nice();

        g.append("g")
        .selectAll("g")
        .data(d3.stack().keys(keys)(this.data))
        .enter().append("g")
        .attr("fill",(d,i) => color[i])
        .selectAll("rect")
        .data((d) => {
            for(var prop in d){
                if(typeof d[prop] === "object")
                d[prop].key = d.key;
            }
            return d;
        })
        .enter().append("rect")
        .attr("x",(d) => x(d.data[this.chartConfig.label]))
        .attr("y",(d) => y(d[1]))
        .attr("height", (d) => { return y(d[0]) - y(d[1]); })
        .attr("width", x.bandwidth())
        .on("click",function(d){
            if(self.barClick && typeof self.barClick === "function")
               self.barClick(d,this); 
        })
        .append("svg:title")
        .text((d,i)=>{
            return ((this.chartConfig.valueFormat) ? d.key + " : " + d3.format(this.chartConfig.valueFormat)(d.data[d.key]) : d.key + " : " + d.data[d.key])
        });

        g.append("g")
        .attr("class", "axis")
        .attr("transform", "translate(0," + height + ")")
        .call(d3.axisBottom(x));

        var yCall = d3.axisLeft(y);
        if(this.chartConfig.valueFormat)
            yCall.tickFormat(d3.format(this.chartConfig.valueFormat));

        g.append("g")
        .attr("class", "axis")
        .call(yCall)
        /*.append("text")
        .attr("x", 2)
        .attr("y", y(y.ticks().pop()) + 0.5)
        .attr("dy", "0.32em")
        .attr("fill", "#000")
        .attr("font-weight", "bold")
        .attr("text-anchor", "start")
        .text("Population");*/

        var legend = g.append("g")
        .attr("font-family", "sans-serif")
        .attr("font-size", 10)
        .attr("text-anchor", "end")
        .selectAll("g")
        .data(keys.slice().reverse())
        .enter().append("g")
        .attr("transform",(d, i) => { return "translate(0," + i * 20 + ")"; });

        legend.append("rect")
        .attr("x", width + margin.right - 15)
        .attr("width", 15)
        .attr("height", 15)
        .attr("fill", (d,i) => color[i]);

        legend.append("text")
        .attr("x", width + margin.right - 17)
        .attr("y", 9.5)
        .attr("dy", "0.32em")
        .attr("text-anchor","end")
        .text((d)=> d);

      }
    }

    window.customElements.define(AwesomeStackedBarChart.is, AwesomeStackedBarChart);
  </script>
</dom-module>
